<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>

  <script type="text/javascript" src="/assets/server-api.js"></script>
  <script type="text/javascript" src="/assets/ws.js"></script>

  <link rel="stylesheet" type="text/css" href="/assets/toastr.css">
  <script type="text/javascript" src="/assets/toastr.js"></script>

  <title>Drapie, pelpa y ratije</title>
  <style>
    body {
      background: linear-gradient(120deg, #f6d365, #fda085);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 400px;
      padding: 20px;
      text-align: center;
      position: relative;
    }

    .title {
      font-size: 1.5em;
      margin-bottom: 10px;
      color: #333;
    }

    .nickname {
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1em;
    }

    .emotar-list {
      max-height: 200px;
      overflow-y: scroll;
      display: grid;
      grid-template-columns: repeat(auto-fill, 50px);
      gap: 10px;
      justify-content: center;
      align-items: center;
    }

    .emotar, .weapon{
      font-size: 1.8em;
      cursor: pointer;
      user-select: none;
      transition: transform 0.8s ease, top 0.8s ease, left 0.8s ease;
      position: relative;
    }

    .weapon {
      font-size: 1em;
    }

    .emotar:hover, .weapon:hover {
      transform: scale(1.2);
      transition: 0.2s;
    }

    .confirm {
      margin-top: 15px;
      padding: 10px 20px;
      background: #fda085;
      border: none;
      color: white;
      border-radius: 5px;
      font-size: 1em;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .confirm:hover {
      background: #f6d365;
    }

    .confirm:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #confirm-weapon-choice.confirm {
      background-color: grey;
    }

    .selected-emotar {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(3);
      font-size: 3em;
      transition: all 0.8s ease;
    }

    .fade-out {
      opacity: 0 !important;
      transition: opacity 1s ease;
    }

    .fade-in {
      opacity: 1 !important;
      transition: opacity 1s ease;
    }

    #selected-nickname {
      opacity: 0;
      color: white;
      font-size: 2em;
    }

    #weapon-selection {
      display: flex;
      flex-direction: row;
      width: 100%;
      align-items: flex-end;
      justify-content: center;
    }

    .explosion {
  width: 100px;
  height: 100px;
  background: radial-gradient(circle, rgba(255,255,0,1) 0%, rgba(255,69,0,1) 60%, rgba(0,0,0,0) 100%);
  border-radius: 50%;
  opacity: 0.8;
  animation: explode 1s ease-out forwards;
}

@keyframes explode {
  0% {
    transform: scale(0.5);
    opacity: 1;
  }
  50% {
    transform: scale(1.5);
    opacity: 0.8;
  }
  100% {
    transform: scale(2);
    opacity: 0;
  }
}
  </style>
</head>
<body>
  <div id="emotar-selector" class="container" >
    <div class="title">Selecciona tu Emotar</div>
    <div class="emotar-list" id="emotar-list">
      <!-- Emotars se cargar√°n aqu√≠ -->
    </div>
    <input type="text" id="nickname" class="nickname" placeholder="Apodo...">
    <button id="confirm-emotar" class="confirm" disabled>Confirmar</button>
  </div>
  <div id="view-nickname"></div>


  <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
    <div id="enemy-place">
      <div class="weapon">‚ùì</div>
      <div>&nbsp;</div>
      <span id="enemy-player-description"></span>
    </div>
    <div id="no-man-land" class="container" style="display: block;">
      <div style="width: 30vw; height: 18vw;"></div>
    </div>
    <div id="weapon-selection">
      <div id="weapon-options" class="weapons" style="display: flex; flex-direction: row; font-size: 2em;">
        <div class="weapon" data-choice="rock">‚úä</div>
        <div class="weapon" data-choice="paper">‚úã</div>
        <div class="weapon" data-choice="scissors">‚úåÔ∏è</div>
      </div>
      <div>&nbsp;</div>
      <button id="confirm-weapon-choice" class="confirm" disabled>Confirmar</button>
      <span id="client-player-description" style="opacity: 0; font-size: 2em;"></span>
    </div>
  </div>

  <script>
    const confirmWeaponChoice = document.getElementById('confirm-weapon-choice');
    const emogiWeapons = document.querySelectorAll(".weapon")
    var selectedWeaponElement
    emogiWeapons.forEach(emogiWeapon => {
      emogiWeapon.onclick = () => selectWeapon(emogiWeapon);
    });

    function selectWeapon(weaponElement) {
      document.querySelectorAll('.weapon').forEach(el => el.style.border = 'none');
      weaponElement.style.border = '2px solid white';
      selectedWeaponElement = weaponElement;
      confirmWeaponChoice.disabled = false;
    }

    confirmWeaponChoice.addEventListener('click', () => {
      if (!selectedWeaponElement) return;

      selectedWeaponElement.style.border = 'none';
      confirmWeaponChoice.disabled = true;

      const noManLand = document.getElementById('no-man-land');
      const noManLandRect = noManLand.getBoundingClientRect();
      const weaponRect = selectedWeaponElement.getBoundingClientRect();

      const weaponClone = selectedWeaponElement.cloneNode(true);
      weaponClone.style.position = 'absolute';
      weaponClone.style.top = `${weaponRect.top}px`;
      weaponClone.style.left = `${weaponRect.left}px`;
      weaponClone.style.transition = 'all 0.8s ease';
      weaponClone.style.fontSize = "2em"
      document.body.appendChild(weaponClone);

      const targetTop = noManLandRect.top + noManLandRect.height / 2;
      const targetLeft = noManLandRect.left + noManLandRect.width / 2;
      setTimeout(() => {
        weaponClone.style.top = `${targetTop}px`;
        weaponClone.style.left = `${targetLeft}px`;
        weaponClone.style.transform = 'translate(-50%, -50%)';
      }, 0);


      setTimeout(() => {
        createExplosion(targetTop - weaponRect.height - 5, targetLeft - weaponRect.width - 10);
        weaponClone.remove();
      }, 1000);
    });


    function createExplosion(top, left) {
      const explosion = document.createElement('div');
      explosion.className = 'explosion';
      explosion.style.position = 'absolute';
      explosion.style.top = `${top}px`;
      explosion.style.left = `${left}px`;
      explosion.style.transform = 'translate(-50%, -50%)';
      document.body.appendChild(explosion);
      //playExplosionSound();


      setTimeout(() => {
        explosion.remove();
      }, 1000);
    }


    function getRandomExplosionSound() {
      const explosionCount = 2;
      const randomIndex = Math.floor(Math.random() * explosionCount) + 1;
      return `explosion_1.mp3`;
    }

    function playExplosionSound() {
      const soundFile = getRandomExplosionSound();
      const boomSound = new Audio(soundFile);
      boomSound.currentTime = 0;
      boomSound.play();
    }
  </script>

  <script>
    const emotars = [
      "üêµ", "üê∂", "üê∫", "ü¶ä", "ü¶ù", "üê±", "ü¶Å", "üêØ",
      "üêÆ", "üê∑", "üê≠", "üêπ", "üê∞", "üêª", "üê®", "üêº" ];

    const emotarListElement = document.getElementById('emotar-list');
    const confirmEmotar = document.getElementById('confirm-emotar');

    let selectedEmotar = null;

    function renderEmotars() {
      emotarListElement.innerHTML = '';
      emotars.forEach(emotar => {
        const emotarDiv = document.createElement('div');
        emotarDiv.className = 'emotar';
        emotarDiv.textContent = emotar;
        emotarDiv.id = emotar
        emotarDiv.onclick = () => selectEmotar(emotar, emotarDiv);
        emotarListElement.appendChild(emotarDiv);
      });
    }

    function selectEmotar(emotar, element) {
      document.querySelectorAll('.emotar').forEach(el => el.style.border = 'none');
      element.style.border = '2px solid #fda085';
      selectedEmotar = emotar;
      confirmEmotar.disabled = false;
    }

    function confirmSelectEmotar(emotar) {
      const element = document.getElementById(emotar)
      const rect = element.getBoundingClientRect();
      const emotarClone = element.cloneNode(true);

      emotarClone.classList.add('selected-emotar');
      emotarClone.style.top = `${rect.top + window.scrollY}px`;
      emotarClone.style.left = `${rect.left + window.scrollX}px`;
      emotarClone.style.position = 'absolute';
      emotarClone.style.border = 'none';

      document.body.appendChild(emotarClone);
      const viewNickname =  document.getElementById("view-nickname")
      const emotarSelector = document.getElementById('emotar-selector');
      const nicknameInput = document.getElementById('nickname')
      var registeredPlayer
      new Promise((resolve) => {
        setTimeout(async () => {
          emotarClone.style.top = '50%';
          emotarClone.style.left = '50%';
          emotarClone.style.transform = 'translate(-50%, -50%) scale(3)';
          const nickname = nicknameInput.value || generateRandonNickname();
          viewNickname.classList.add('fade-in');
          viewNickname.innerText = nickname
          player = {
            name: nickname,
            emotar: emotar,
          };

          try {
            var ws = await WebSockets.DefaultService.adquire()
            console.log("Adquired ws is ", ws)
            registeredPlayer = await ServerApi.DefaultService.registerPlayer(player);
            resolve()
          } catch (err) {
            console.error("Error adquiring ws", err)
          }
        }, 250)
      }).then(() => {
        return new Promise((resolve) => {
          setTimeout(() => {
            emotarClone.classList.add('fade-out');
            viewNickname.classList.remove('fade-in');
            viewNickname.classList.add('fade-out');
            resolve()
          }, 1000)
        })
      }).then(() => {
        return new Promise((resolve) => {
          setTimeout(() => {
            const noManLand = document.getElementById('no-man-land');
            noManLand.style.display = "block";
            noManLand.style.opacity = "0";
            noManLand.classList.add('fade-in');
            emotarSelector.style.display = "none";
            nicknameInput.style.display = "none";
            resolve()
          }, 500)
        }).then(() => {
          var clientPlayerDescription = document.getElementById("client-player-description")
          clientPlayerDescription.innerText = registeredPlayer.name + " " + registeredPlayer.emotar
          clientPlayerDescription.classList.add('fade-in');
        })
      })
      emotarSelector.classList.add('fade-out');
    }

    confirmEmotar.addEventListener('click', () => {
      if (selectedEmotar) {
        confirmSelectEmotar(selectedEmotar)
      }
    });

    renderEmotars();

    const adjectives = [
      "mysterious", "happy", "brave", "curious", "playful",
      "sneaky", "wild", "gentle", "kind", "fierce",
      "sassy", "clever", "sleepy", "funny", "bright"
    ];
    function generateRandonNickname() {
      const randomAdjective = adjectives[Math.floor(Math.random() * adjectives.length)]
      const capitalizedRandomAdjective = randomAdjective[0].toLocaleUpperCase() + randomAdjective.slice(1, randomAdjective.length)
      return `${capitalizedRandomAdjective}`;
    }
  </script>

  <script>
  function setupWebsocket(webSocket) {
    const onmessage = (event) => {
      const notification = JSON.parse(event.data);
      switch (notification.kind) {
        case "enemy-enter-game":
        console.log("enemy-enter-game", notification?.kind);
          break
        case "enemy-choice-weapon":
          console.log("enemy-choice-weapon", notification?.kind);
          break
        default:
          console.log("not processing ", notification?.kind);
          break;
      }
    };
    webSocket.addEventListener("message", onmessage);
    window.addEventListener("beforeunload", () => {
      webSocket.removeEventListener("message", onmessage);
    });
  }
  </script>
</body>
</html>
